# Control 1.20: Network Isolation and Private Connectivity

## Overview

**Control ID:** 1.20
**Control Name:** Network Isolation and Private Connectivity
**Regulatory Reference:** FINRA 3110, SEC 17a-4, GLBA 501(b), OCC 2011-12
**Setup Time:** 2-4 hours per environment (includes Azure networking prerequisites)

---

## Prerequisites

- **License Required:** Power Apps Premium or Power Automate Premium (per-user or per-app); Azure subscription for VNet/Private Endpoint resources - [Learn more](https://learn.microsoft.com/en-us/microsoft-copilot-studio/admin-network-isolation-vnet)
- **Primary Owner Admin Role:** Power Platform Admin + Azure Network Contributor
- **Dependencies:** Control 2.1 (Managed Environments) must be enabled; Azure Virtual Network provisioned
- **Additional Requirements:** Environment must be Managed; Azure subscription in same tenant; Private DNS zones configured

---

## Governance Levels

### Baseline (Level 1)

Enable IP Firewall to restrict environment access by IP address ranges. This provides basic network-level access control without requiring Azure VNet infrastructure.

- Configure IP allowlist for corporate network ranges
- Block access from non-approved IP addresses
- Document approved IP ranges and business justification

### Recommended (Level 2-3)

Deploy Virtual Network (VNet) support for Zone 2+ agents that access sensitive data sources. Configure Private Endpoints for Key Vault and Application Insights.

- Enable VNet support in Managed Environments
- Configure Private Endpoints for data sources (SQL, Key Vault)
- Route Application Insights telemetry over Private Link
- Implement IP Firewall as complementary control

### Regulated/High-Risk (Level 4)

Mandatory VNet isolation with Private Endpoints for all data connectivity. Network flow monitoring and logging required. No public internet exposure for agent-to-data-source communication.

- Full VNet isolation for all enterprise agents
- Private Endpoints for all supported connectors
- Network flow logs retained per SEC 17a-4 requirements
- Regular network security assessments

---

## Setup & Configuration

### Portal-Based Configuration (Primary Method)

**Step 1: Verify Managed Environment Prerequisites**

1. Sign in to the **Power Platform Admin Center** ([https://admin.powerplatform.microsoft.com](https://admin.powerplatform.microsoft.com))
2. Navigate to **Environments** > select your target environment
3. Confirm **Managed Environment** is enabled (see Control 2.1)
4. Note the environment's Azure region for VNet placement

**Step 2: Configure IP Firewall (Baseline)**

1. In PPAC, navigate to **Environments** > select target environment
2. Select **Settings** > **Product** > **Privacy + Security**
3. Locate **IP firewall** section
4. Enable **Enable IP address based firewall rule**
5. Configure IP ranges:
   - Add corporate network CIDR blocks (e.g., `10.0.0.0/8`, `172.16.0.0/12`)
   - Add VPN gateway IP ranges if applicable
   - Add Azure service tags if using Azure-hosted clients
6. Set **Service tags allowed**:
   - Enable for Azure services that need access (e.g., `AzureCloud`)
7. Enable **Enable IP firewall in audit-only mode** initially for testing
8. After validation, disable audit-only mode for enforcement
9. Select **Save**

[Screenshot needed: IP Firewall configuration panel with sample IP ranges]

**Step 3: Configure Virtual Network Support**

!!! note "Azure Prerequisite"
    VNet support requires an Azure Virtual Network in the same region as your Power Platform environment, with a dedicated subnet for Power Platform integration.

1. In PPAC, navigate to **Environments** > select target environment
2. Select **Settings** > **Product** > **Privacy + Security**
3. Locate **Virtual Network** section
4. Select **Set up** or **Edit** for Virtual Network configuration
5. Configure the following:
   - **Subscription**: Select Azure subscription containing your VNet
   - **Virtual Network**: Select the target VNet
   - **Subnet**: Select or create a dedicated subnet (minimum /24 recommended)
6. Review the subnet requirements:
   - Subnet must be delegated to `Microsoft.PowerPlatform/enterprisePolicies`
   - Subnet must have sufficient IP addresses for expected workload
7. Select **Save** and wait for provisioning (may take 15-30 minutes)

[Screenshot needed: VNet configuration panel showing subscription, VNet, and subnet selection]

**Step 4: Configure Private Endpoints for Azure Key Vault**

Enable agents to retrieve secrets from Key Vault without public internet exposure:

1. In **Azure Portal** ([https://portal.azure.com](https://portal.azure.com))
2. Navigate to your **Key Vault** resource
3. Select **Networking** > **Private endpoint connections**
4. Select **+ Private endpoint**
5. Configure:
   - **Name**: `pe-keyvault-powerplatform-{env}`
   - **Region**: Same as Power Platform environment
   - **Resource type**: `Microsoft.KeyVault/vaults`
   - **Target sub-resource**: `vault`
   - **Virtual Network**: Select the VNet configured in Step 3
   - **Subnet**: Select appropriate subnet for private endpoints
   - **Private DNS integration**: Enable and select/create private DNS zone
6. Review and create the private endpoint
7. Update Key Vault firewall to deny public access (if appropriate for your scenario)

[Screenshot needed: Azure Private Endpoint creation for Key Vault]

**Step 5: Configure Application Insights with Private Link**

Route telemetry data over private network:

1. In **Azure Portal**, navigate to your **Application Insights** resource
2. Select **Network Isolation** or navigate via **Properties** > **Network Isolation**
3. Select **Configure** under **Private Link Configuration**
4. Create or link to an **Azure Monitor Private Link Scope (AMPLS)**:
   - Select **+ Create a private link scope** or use existing
   - Add the Application Insights resource to the scope
5. Create Private Endpoint for the AMPLS:
   - Navigate to the Private Link Scope resource
   - Select **Private endpoint connections** > **+ Private endpoint**
   - Configure endpoint in the same VNet as Power Platform
6. Configure network isolation mode:
   - Set **Accept data ingestion from public networks**: Disabled (for strict isolation)
   - Set **Accept queries from public networks**: Configure per requirements

[Screenshot needed: Application Insights network isolation configuration]

**Step 6: Configure VNet-Supported Connectors**

For data sources like SQL Server or Azure SQL:

1. In **Azure Portal**, navigate to your **Azure SQL Server** resource
2. Select **Networking** or **Firewalls and virtual networks**
3. Add Private Endpoint:
   - Select **Private endpoint connections** > **+ Private endpoint**
   - Configure in the Power Platform VNet
   - Enable Private DNS integration
4. Configure firewall rules:
   - Disable **Allow Azure services and resources to access this server** (for strict isolation)
   - Ensure private endpoint connectivity is established before disabling public access
5. In **Copilot Studio** or **Power Platform**, use the connector with connection string pointing to the private FQDN

**Step 7: Enable IP Cookie Binding (Optional Enhancement)**

Prevent session token theft by binding sessions to IP addresses:

1. In PPAC, navigate to **Environments** > select target environment
2. Select **Settings** > **Product** > **Privacy + Security**
3. Enable **IP address-based cookie binding**
4. Select **Save**

!!! warning
    IP cookie binding may cause issues for users with dynamic IPs or those using VPNs with rotating exit nodes. Test thoroughly before enabling in production.

<a id="configuration-matrix"></a>

**Configuration Matrix by Governance Level:**

| Setting | Baseline | Recommended | Regulated |
|---------|----------|-------------|-----------|
| IP Firewall | Enabled | Enabled | Enabled + strict ranges |
| VNet Support | Not required | Enabled for Zone 2+ | Mandatory |
| Key Vault Private Endpoint | Not required | Recommended | Mandatory |
| App Insights Private Link | Not required | Recommended | Mandatory |
| SQL/Data Private Endpoints | Not required | For sensitive data | Mandatory |
| IP Cookie Binding | Optional | Recommended | Enabled |
| Public endpoint access | Allowed | Limited | Denied where possible |

### PowerShell/CLI Configuration (Alternative Method)

```powershell
# Prerequisites: Az module, Microsoft.PowerApps.Administration.PowerShell
# Install-Module -Name Az -Scope CurrentUser
# Install-Module -Name Microsoft.PowerApps.Administration.PowerShell -Scope CurrentUser

# Connect to Azure
Connect-AzAccount

# Connect to Power Platform
Add-PowerAppsAccount

# Variables
$resourceGroup = "rg-powerplatform-network"
$vnetName = "vnet-powerplatform-prod"
$subnetName = "snet-powerplatform-delegation"
$location = "eastus"
$keyVaultName = "kv-fsi-agents-prod"

# Create VNet if not exists
$vnet = Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroup -ErrorAction SilentlyContinue
if (-not $vnet) {
    $vnet = New-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroup `
        -Location $location -AddressPrefix "10.100.0.0/16"
}

# Create subnet with delegation for Power Platform
$subnetConfig = @{
    Name = $subnetName
    AddressPrefix = "10.100.1.0/24"
    Delegation = @(
        @{
            Name = "PowerPlatformDelegation"
            ServiceName = "Microsoft.PowerPlatform/enterprisePolicies"
        }
    )
}
Add-AzVirtualNetworkSubnetConfig @subnetConfig -VirtualNetwork $vnet
$vnet | Set-AzVirtualNetwork

# Create Private Endpoint for Key Vault
$keyVault = Get-AzKeyVault -VaultName $keyVaultName -ResourceGroupName $resourceGroup
$privateEndpointConnection = New-AzPrivateLinkServiceConnection `
    -Name "plsc-keyvault-pp" `
    -PrivateLinkServiceId $keyVault.ResourceId `
    -GroupId "vault"

$subnet = Get-AzVirtualNetworkSubnetConfig -Name "snet-private-endpoints" -VirtualNetwork $vnet
New-AzPrivateEndpoint -Name "pe-keyvault-powerplatform" `
    -ResourceGroupName $resourceGroup `
    -Location $location `
    -Subnet $subnet `
    -PrivateLinkServiceConnection $privateEndpointConnection

# Create Private DNS Zone for Key Vault
$privateDnsZone = New-AzPrivateDnsZone -ResourceGroupName $resourceGroup `
    -Name "privatelink.vaultcore.azure.net"

# Link DNS Zone to VNet
New-AzPrivateDnsVirtualNetworkLink -ResourceGroupName $resourceGroup `
    -ZoneName "privatelink.vaultcore.azure.net" `
    -Name "vnetlink-keyvault" `
    -VirtualNetworkId $vnet.Id

# Validation: Check private endpoint status
Get-AzPrivateEndpoint -ResourceGroupName $resourceGroup |
    Select-Object Name, ProvisioningState, @{N='ConnectionStatus';E={$_.PrivateLinkServiceConnections.PrivateLinkServiceConnectionState.Status}}
```

---

## Financial Sector Considerations

### Regulatory Alignment

| Regulation | Requirement | How This Control Helps |
|------------|-------------|------------------------|
| **FINRA 3110** | Supervise communications and access to customer info | Network isolation prevents agents from reaching unapproved systems; enables monitoring of network flows |
| **SEC 17a-4** | Records preservation with tamper-evident controls | Private networks prevent unauthorized external access to agent data and logs |
| **GLBA 501(b)** | Implement safeguards for customer information | Network boundaries separate agent infrastructure from public internet; defense in depth |
| **OCC 2011-12** | Model risk management including data integrity | Network isolation controls and validates data feeds to agents; prevents unauthorized data sources |

### Zone-Specific Configuration

**Zone 1 (Personal Productivity):**

- IP Firewall recommended but not required
- VNet support typically not necessary for personal productivity agents
- Rationale: Low data sensitivity; administrative overhead outweighs risk reduction

**Zone 2 (Team Collaboration):**

- IP Firewall required (minimum)
- VNet support recommended for agents accessing shared data
- Private Endpoints recommended for sensitive data sources
- Rationale: Shared agents may access team-level confidential data; network controls reduce blast radius

**Zone 3 (Enterprise Managed):**

- Full VNet isolation mandatory
- Private Endpoints required for all data connections
- Network flow logging enabled
- No public internet exposure for agent-to-backend communication
- Rationale: Enterprise agents handle the most sensitive customer and financial data; maximum network isolation required

### FSI Implementation Example

**Scenario:** Regional bank deploying customer service agents that access CRM data and internal knowledge bases

**Configuration:**

```yaml
Organization: Regional Banking Institution
Environment: FSI-Customer-Service-Prod
Zone: 3 (Enterprise Managed)

Network Configuration:
  IP Firewall:
    Status: Enabled
    Allowed Ranges:
      - 10.0.0.0/8 (Corporate network)
      - 172.16.0.0/12 (Branch networks)
    Service Tags:
      - AzureCloud (for Azure PaaS)
    Audit Mode: Disabled (enforcing)

  VNet Support:
    Status: Enabled
    Virtual Network: vnet-fsi-agents-eastus
    Subnet: snet-powerplatform-delegation (/24)
    Region: East US (matches environment)

  Private Endpoints:
    Key Vault:
      - Name: pe-kv-agents-prod
      - DNS Zone: privatelink.vaultcore.azure.net
    Azure SQL (CRM):
      - Name: pe-sql-crm-prod
      - DNS Zone: privatelink.database.windows.net
    Application Insights:
      - AMPLS: ampls-fsi-monitoring
      - Private Endpoint: pe-ampls-agents

  IP Cookie Binding: Enabled

Compliance Documentation:
  - Network diagram with data flows
  - Private endpoint inventory
  - IP allowlist approval records
  - Quarterly network access reviews
```

**Documentation Requirements:**

- Network architecture diagram showing agent data flows
- Inventory of all private endpoints and their target resources
- IP allowlist with business justification for each range
- Evidence of quarterly network security assessments

---

## Verification & Testing

1. **Verify IP Firewall:** Attempt to access the environment from a non-allowlisted IP address
2. **Test VNet connectivity:** Confirm agent can reach private endpoint resources
3. **Validate Private DNS:** Resolve private endpoint FQDNs from within VNet
4. **Test Key Vault access:** Agent retrieves secret via private endpoint (no public route)
5. **Verify Application Insights:** Telemetry data flows to App Insights via Private Link
6. **Negative test:** Attempt public endpoint access after disabling (should fail)

**EXPECTED:** Agents operate normally using private network paths; public access attempts blocked; all telemetry routed via Private Link.

---

## Troubleshooting & Validation

### Common Issues

| Issue | Cause | Resolution |
|-------|-------|------------|
| VNet provisioning fails | Subnet not delegated to Power Platform | Verify subnet delegation is set to `Microsoft.PowerPlatform/enterprisePolicies` |
| Agent cannot reach data source | Private DNS not resolving | Check Private DNS Zone is linked to VNet; verify A records exist |
| IP Firewall blocks legitimate users | IP range not in allowlist | Add missing CIDR ranges; check for NAT/proxy IP changes |
| Private endpoint connection pending | Missing approval or DNS config | Approve connection in resource; configure DNS integration |
| Telemetry not flowing | AMPLS misconfigured | Verify App Insights is added to Private Link Scope; check network isolation settings |

### How to Confirm Configuration is Active

1. **Via Portal:**
   - PPAC → Environment → Settings → Privacy + Security
   - Confirm IP Firewall enabled and VNet configured
   - Azure Portal → Private Endpoints → Status shows "Succeeded"

2. **Via PowerShell:**
   ```powershell
   # Check private endpoint status
   Get-AzPrivateEndpoint -ResourceGroupName "rg-powerplatform-network" |
       Select-Object Name, ProvisioningState

   # Test DNS resolution from within VNet
   Resolve-DnsName "mykeyvault.vault.azure.net" -Server 10.100.0.4
   # Should resolve to private IP (10.x.x.x), not public IP
   ```

3. **Via User Testing:**
   - Deploy test agent that accesses Key Vault secret
   - Verify agent functions correctly
   - Review network flow logs to confirm private path usage
   - Expected result: Data flows show internal IPs only, no public internet routing

---

## Additional Resources

- [Virtual Network support for Copilot Studio](https://learn.microsoft.com/en-us/microsoft-copilot-studio/admin-network-isolation-vnet)
- [IP Firewall for Power Platform](https://learn.microsoft.com/en-us/power-platform/admin/ip-firewall)
- [Azure Private Link overview](https://learn.microsoft.com/en-us/azure/private-link/private-link-overview)
- [Azure Monitor Private Link Scope](https://learn.microsoft.com/en-us/azure/azure-monitor/logs/private-link-security)
- [Key Vault Private Endpoints](https://learn.microsoft.com/en-us/azure/key-vault/general/private-link-service)
- [Power Platform Admin Center](https://admin.powerplatform.microsoft.com)

---

## Related Controls

| Control | Relationship |
|---------|--------------|
| [2.1 - Managed Environments](../pillar-2-management/2.1-managed-environments.md) | Prerequisite - VNet support requires Managed Environment |
| [1.15 - Encryption: Data in Transit and at Rest](1.15-encryption-data-in-transit-and-at-rest.md) | Complementary - Network isolation + encryption provides defense in depth |
| [1.7 - Comprehensive Audit Logging](1.7-comprehensive-audit-logging-and-compliance.md) | Related - Network flow logs supplement audit logging |
| [1.11 - Conditional Access and MFA](1.11-conditional-access-and-phishing-resistant-mfa.md) | Complementary - IP-based CA policies align with IP Firewall |

---

## Support & Questions

For implementation support or questions about this control, contact:

- **AI Governance Lead** (governance direction)
- **Network Security Team** (VNet and firewall configuration)
- **Azure Platform Team** (Private Endpoint setup)
- **Compliance Officer** (regulatory requirements)

---

**Updated:** Jan 2026
**Version:** v1.0 (Jan 2026)
**UI Verification Status:** ❌ Needs verification
